// === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
window.addEventListener('DOMContentLoaded', () => {
  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
  restoreFilters();

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–∞—Å—Å–∏–≤–∞ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∞ —Å–ª—É—á–∞–π –ø—É—Å—Ç–æ–≥–æ –∫—ç—à–∞
  selectedCampaigns = Array.from(
    document.querySelectorAll("#campaign-dropdown .campaign-toggle.active")
  ).map(el => el.dataset.value);

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏
  const campBtn = document.querySelector("#campaign-dropdown .dropdown-btn");
  if (campBtn) {
    campBtn.textContent = selectedCampaigns.length > 0
      ? `–í—ã–±—Ä–∞–Ω–æ: ${selectedCampaigns.length} ‚ñæ`
      : "–í—ã–±—Ä–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏ ‚ñæ";
  }
  
  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–º—ã
  const savedTheme = localStorage.getItem("theme");
  const isDark = savedTheme === "dark";

  const themeSwitch = document.getElementById("theme-switch");
  if (themeSwitch) {
    themeSwitch.addEventListener("click", () => {
      const root = document.documentElement;
      const currentTheme = root.getAttribute("data-theme");
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      root.setAttribute("data-theme", newTheme);
      localStorage.setItem("theme", newTheme);
    });
  }

  applyTheme(isDark);

  // ==============================
  // üìÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π
  // ==============================
  const fpStart = flatpickr("#start-date", {
    dateFormat: "Y-m-d",
    allowInput: false
  });

  const fpEnd = flatpickr("#end-date", {
    dateFormat: "Y-m-d",
    allowInput: false
  });

  // üìå –ö–ª–∏–∫ –ø–æ –∏–∫–æ–Ω–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å
  document.querySelectorAll(".input-with-icon").forEach(group => {
    const input = group.querySelector("input");
    const iconBtn = group.querySelector(".calendar-wrapper");

    if (input && iconBtn) {
      iconBtn.addEventListener("click", () => {
        const fp = input._flatpickr;
        if (fp) fp.open();
      });
    }
  });

  // –°—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
  applyFilters();

  // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  startAutoRefresh(30000);

  // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ ===
  const showBtn = document.getElementById('show-btn');
  const clearBtn = document.getElementById('clear-btn');
  const downloadChartPngBtn = document.getElementById("download-chart-png");
  const downloadMarkdownBtn = document.getElementById("download-markdown");

  if (showBtn) {
    showBtn.addEventListener('click', () => {
      saveFilters();
      applyFilters();
    });
  }

  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      localStorage.removeItem('filters');
      document.getElementById('filter-form').reset();
      clearFilters();
    });
  }

  // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞, –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ —Ç.–¥.
});
